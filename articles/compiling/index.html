<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Compiling C with Rakefiles &#8211; Donald Hutchison</title>
<meta name="description" content="Make is solid. It’s been around since before the internet and still one of the most important tools used today. As such - it’s tried, proven, tested, and was used insome of the most successful projects out there.

">
<meta name="keywords" content="ruby, rake, c">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Compiling C with Rakefiles">
<meta name="twitter:description" content="Make is solid. It’s been around since before the internet and still one of the most important tools used today. As such - it’s tried, proven, tested, and was used insome of the most successful projects out there.

">
<meta name="twitter:site" content="@rev_kachowski">
<meta name="twitter:creator" content="@rev_kachowski">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/headers/rake-header.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Compiling C with Rakefiles">
<meta property="og:description" content="Make is solid. It’s been around since before the internet and still one of the most important tools used today. As such - it’s tried, proven, tested, and was used insome of the most successful projects out there.

">
<meta property="og:url" content="/articles/compiling/">
<meta property="og:site_name" content="Donald Hutchison">





<link rel="canonical" href="/articles/compiling/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Donald Hutchison Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="/" >Home</a></li>
		  
		    
		        
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		        
		    
		    <li><a href="/articles/" >Articles</a></li>
		  
		    
		        
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		        
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
        <li class="dosearch"><span><i class="fa fa-search"></i> Search</span></li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
  <div class="search-form">
    <input type="text" class="search-field" placeholder="Search...">
    <button class="close-btn"><i class="fa fa-times-circle fa-2x"></i></button>
    <ul class="search-results post-list"></ul><!-- /.search-results -->
  </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	
		<div class="wrap">
			<a href="" class="site-logo" rel="home" title="Donald Hutchison"><img src="/images/site-logo.png" width="200" height="200" alt="Donald Hutchison logo" class="animated bounceInDown"></a>
		</div>
	
</header><!-- /.masthead -->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    <img src="/images/headers/rake-header.jpg" class="entry-feature-image" alt="Compiling C with Rakefiles" >
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="/tags/#ruby" title="Pages tagged ruby">ruby</a>&nbsp;&bull;&nbsp;<a href="/tags/#rake" title="Pages tagged rake">rake</a>&nbsp;&bull;&nbsp;<a href="/tags/#c" title="Pages tagged c">c</a></span>
        
          <h1 class="entry-title">Compiling C with Rakefiles</h1>
        
      </header>
      <footer class="entry-meta">
        
        
        
          <img src="/images/portrait.png" class="bio-photo" alt="Donald Hutchison bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Donald Hutchison</span></span>
        <span class="entry-date date published"><time datetime="2014-10-19T19:46:40+02:00"><i class="fa fa-calendar-o"></i> October 19, 2014</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        
      </footer>
      <div class="entry-content">
        <p><a href="https://www.gnu.org/software/make/">Make</a> is solid. It’s been around since before the internet and still one of the most important tools used today. As such - it’s tried, proven, tested, and was used insome of the most successful projects out there.</p>

<p>…but what are the chances that something so old got it right the first time? What are the chances that good old <em>Make</em> is the be-all, end-all, perfect ultimate solution for every possible development project? Of course not, and noone says it is - so let’s try an exercise in frustration and compile some C using <a href="https://github.com/jimweirich/rake">Rake</a> - the cool fresh ruby little brother to big pappy Make.</p>

<h3 id="brief-history-of-rake">brief history of rake</h3>

<blockquote>
  <p>Rake is a Make-like program implemented in Ruby</p>
</blockquote>

<p><em>Rake</em> is Ruby’s version of the <em>Make</em> build system. Created in 2003 by the late Jim Weirich, it’s goal is to get away from the idiosyncratic build system syntax and express build rules in plain Ruby. According to <a href="https://en.wikipedia.org/wiki/Jim_Weirich#Rake">wikipedia</a>, it’s the most downloaded ruby gem of all time and has been bundled with OSX since 2011. </p>

<p>Rake has a diverse set of functions but in my experience it’s primarily used to drive a single command line interface for a ton of unrelated scripts and tools. By invoking your scripts from rake tasks you can create a single unified point of access for both developers and other tools to work with. This is cool for a variety of reasons, e.g. having a Continuous Integration server run the rake task directly gives a build system that is both under version control and available locally. But this is true of many build systems… Where <em>Rake</em> really shines is in it’s incredibly powerful <code>File</code>, <code>Rule</code> and <code>Task</code> functionality. </p>

<p>I was lucky enough to see Jim’s <a href="https://www.youtube.com/watch?v=KaEqZtulOus">Power Rake</a> presentation at the Scottish Ruby Conference in 2012 where he spoke at length about the awesomeness of the <code>pathmap</code> method and the <code>FileList</code> class. Why not use these tools for modern C development? Even though one of the <a href="https://github.com/jimweirich/rake/blob/de564de4e2f189e1b133e4adf05ab8fc820a044b/rake/doc/example/Rakefile1">first examples</a> ever provided was using Rake to compile a basic C program, it still lacks behind <em>Make</em>’s out of the box no-config compilation rules. Let’s see what it takes to get a <em>Rake</em> to walk like a <em>Make</em>.</p>

<h3 id="lets-make-rake-like-make">let’s make rake like make</h3>
<p>(no arguments, implicit rules for object and executables)
Even without a Makefile, <em>Make</em> can still work out how to compile and link your C files. Without a Rakefile, <em>Rake</em> is a thing that isn’t useful.</p>

<p>This is because of the huge library of implicit rules and behaviour that <em>Make</em> has collected over it’s lifetime in the battlefield. Type <code>make -p</code> in a directory without a Makefile to list what it already knows before you’ve told it anything. Rake has none of this, so we’ll need to replicate some functionality before we have a contender on our hands.</p>

<h4 id="the-goal">the goal</h4>

<p>What we want is the same “no config” approach in Rake that Make has. Given a directory that looks like</p>

<p><code>
├── Rakefile
├── foo.c
</code></p>

<p>We want to be able to run <code>rake foo</code> and end up with an executable named <code>foo</code>. Additionally we could also run <code>rake foo.o</code> and create the intermediate object file directly.</p>

<h4 id="makes-implicit-rules">make’s implicit rules</h4>

<p>The functionality we need to steal from <em>Make</em> to get our basic compilation working is
* <strong>creating .o files from .c files</strong>
* <strong>creating executables</strong>
* <strong>automatically linking object files we depend on</strong></p>

<p>We can see from Rake’s <a href="https://github.com/jimweirich/rake/blob/f374191fdeca537c57472bb2b469f4b5faa8ed7f/lib/rake/task_manager.rb#L66">task manager</a> source that a file
task is generated when rake is given an argument which matches an existing file in the pwd. Now that we know this fact, we can add rules that will force arbitrary filenames passed to <em>Rake</em> result in compilation.</p>

<h4 id="creating-o-files-from-c-files">creating .o files from .c files</h4>

<p>The first step will be to compile an object ( <code>.o</code>) file from a corresponding <code>.c</code> file. <em>Make</em> has this defined as <code>$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c</code>, stripping this down and expressing it in <em>Rake</em>’s rule syntax, we get</p>

<p><code>ruby
rule ".o" =&gt; ".c" do |t|
    `cc -c #{t.source} -o #{t.name}`
end
</code></p>

<p>The first line basically says “whenever I need a *.o file, I also need an existing .c file with the same name”. Now in our example - when we run <code>rake foo.o</code>, the foo.o will match against the .o section, and then following the rule rake will look for a corresponding <code>foo.c</code> file, find it, and finally execute the block. </p>

<p>Rake passes a <a href="https://github.com/jimweirich/rake/blob/master/lib/rake/task.rb">Task</a> instance into the block, which is populated with a lot of information about the rule we just followed. From this task we take out the source (<code>foo.c</code>) and the output name (<code>foo.o</code>) and then pass them into the compiler via a shell invocation.</p>

<h4 id="create-executable-from-c">create executable from .c</h4>

<p>What we want to do here is solve the situation of <code>rake foo</code> and directly create an executable without the intermediate fluff hanging around. This can be done by matching the rule against a regular expression. </p>

<p>Rather awkwardly, we want something that matches against a string <em>without</em> a file extension. To specify that we match against any string would end up creating a circular dependency with the rule above. We can naively match a file extension with the expression <code>/\w*\.\w*/</code> (we’re not going to take multiple dots in filename into account), then we can <a href="http://zijab.blogspot.de/2008/09/finding-opposite-of-regular-expression.html">invert that pattern</a> and get the horrible looking <code>/^((?!\w*\.\w*).)*$/</code>which should match any single word without a file extension attached.</p>

<p>Throwing that into <em>Rake</em> and adding the compilation + linking will give us</p>

<p><code>ruby
rule /^((?!\w*\.\w*).)*$/ =&gt; ".c" do |t|
    `cc #{t.source} -o #{t.name}`
end
</code></p>

<h4 id="linking-from-multiple-files">linking from multiple files</h4>

<p>So far so good. We can now compile very simple C executables with nothing but Ruby. Granted, we need the presence of a Rakefile and some arcane rules to compile everything correctly (not to mention Ruby + Rake installed with appropriate versions…), but we can compile arbitrary programs nonetheless.</p>

<p>But what if we want to do something non trivial?? With a single line in a Makefile like <code>x: y.o z.o</code> we can compile and link against any number of object files. This makes it  actually useful! How can we go about adding this into <em>Rake</em>?</p>

<p>Pretty easily actually, thanks to the Ruby standard library. As mentioned above, the <code>Task</code> object in <em>Rake</em> contains a lot of useful information, including a list of dependencies for the task. We can extract any object files and then pass them into the call to <code>cc</code> by changing the rule above as follows.</p>

<p><code>ruby
rule /^((?!\w*\.\w*).)*$/ =&gt; ".c" do |t|
    deps = t.prerequisites
    objects = deps.select { |d| d.pathmap == ".o" }
    `cc #{t.source} #{objects.join ' '} -o #{t.name}`
end
</code></p>

<p>Now if we add a similar rule to our <em>Rakefile</em> (in our case <code>file 'x' =&gt; ["y.o',"z.o"]</code>) <em>Rake</em> will resolve the dependencies, compiling <code>y.c</code> and <code>z.c</code> into object files before compiling <code>x.c</code> and linking against <code>y.o</code> and <code>z.o</code>. Cool!</p>

<p>Now (after some minor tidying) we have a  very basic <em>Rakefile</em> like this which will let us compile just like we’re using <em>Make</em></p>

<script src="https://gist.github.com/be91c426b46725c20250.js"> </script>

<h3 id="round-one---fight">Round One - Fight!</h3>

<p>OK, now we have our contender. Let’s throw him in the ring and see how he stands against a pro. Let’s not start small, let’s go all out brave or grave. We’re going to take the <em>Makefile</em> from <a href="http://zedshaw.com/">Zed A. Shaw’s</a> awesome <a href="http://c.learncodethehardway.org/">Learn C The Hard Way</a> series, and see how we can trick out our <em>Rakefile</em> to do the same tasks. Then we’ll decide which solution is more convenient, readable and maintainable.</p>

<p>After following through <em>Learn C The Hard Way</em> you end up with a <em>Makefile</em> that should look like <a href="https://github.com/rkachowski/c-the-hard-way/blob/master/liblcthw/Makefile">this</a></p>

        <div id="disqus_thread"></div><!-- /#disqus_thread -->
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/articles/how-to-write-bug-reports/" class="btn" title="How to write a bug report">Previous</a>
      
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2014 Donald Hutchison. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/rev_kachowski" title="Donald Hutchison on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	<a href="http://linkedin.com/in/https://www.linkedin.com/pub/donald-hutchison/22/a70/16a" title="Donald Hutchison on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="https://careers.stackoverflow.com/donaldhutchison" title="Donald Hutchison on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	
	
	<a href="http://github.com/rkachowski" title="Donald Hutchison on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
    <a href="https://keybase.io/rkachowski" title="Donald Hutchison on keybase" target="_blank"><i class="fa fa-key fa-2x"></i></a>
  <a href="/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>
<script src="/assets/js/subtitle.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').jekyllSearch({
          jsonFile: '/search.json',
          searchResults: '.search-results',
          template: '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          fuzzy: true,
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".close-btn"),
          searchform: $(".search-form"),
          canvas: $(".js-menu-screen"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      $('body').toggleClass('no-scroll');
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('is-visible');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        $('body').toggleClass('no-scroll');
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('is-visible');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-17488316-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'donaldhutchisoninfo'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


	        

</body>
</html>
